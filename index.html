<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K覺yasGO - Ak覺ll覺 Fiyat Kar覺lat覺rma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        #ai-assistant-section {
            background: linear-gradient(135deg, #eff6ff 0%, #ffebeb 100%);
        }
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 20px; }
        
        /* Aktif men羹 linki i癟in stil */
        .nav-link.active {
            color: #2563eb; /* text-blue-600 */
            border-bottom-color: #2563eb; /* border-blue-600 */
        }
        /* YEN襤: Men羹 ge癟i stili */
        #side-menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">

    <!-- 1. HEADER: ARAMA UBUU VE MEN -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <!-- GNCELLEND襤: st sat覺r (Logo, Arama, Men羹 Butonu) -->
            <div class="flex justify-between items-center gap-4">
                <a href="index.html" class="text-3xl font-extrabold text-blue-600 flex-shrink-0">
                    K覺yas<span class="text-red-600">GO</span>
                </a>
                
                <div class="relative w-full max-w-2xl hidden md:block">
                    <input type="search" id="search-input" placeholder="Arad覺覺n覺z 羹r羹n羹 yaz覺n (繹rn: 'iPhone 15 Pro')" class="w-full pl-5 pr-12 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    <button id="search-button" class="absolute right-0 top-0 h-full px-5 text-gray-500 hover:text-blue-600 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                    </button>
                </div>

                <!-- YEN襤: Hamburger Men羹 Butonu -->
                <button id="menu-open-btn" class="text-gray-600 hover:text-blue-600 p-2 rounded-full">
                    <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>

            <!-- GNCELLEND襤: Mobil i癟in Arama ubuu (st sat覺r覺n alt覺nda) -->
            <div class="relative w-full mt-4 md:hidden">
                <input type="search" id="search-input-mobile" placeholder="Arad覺覺n覺z 羹r羹n羹 yaz覺n..." class="w-full pl-5 pr-12 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <button id="search-button-mobile" class="absolute right-0 top-0 h-full px-5 text-gray-500 hover:text-blue-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </button>
            </div>


            <!-- KATEGOR襤 MENS L襤NKLER襤 (BU BLM S襤L襤ND襤) -->

        </nav>
    </header>

    <!-- 2. ANA 襤ER襤K: ANA SAYFA -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[calc(100vh-450px)]">
        
        <!-- Balang覺癟 Mesaj覺 -->
        <div id="page-start-message" class="page-section text-center text-gray-500 py-16">
            <svg class="w-16 h-16 mx-auto text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
            </svg>
            <h2 class="text-2xl font-semibold mt-4">En iyi fiyatlar覺 bulmaya balay覺n</h2>
            <p class="text-lg mt-2">Kar覺lat覺rmak istediiniz 羹r羹n羹 yukar覺daki 癟ubua yaz覺n.</p>
        </div>

        <!-- Arama Sonu癟lar覺 B繹l羹m羹 -->
        <section id="page-results-section" class="page-section hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
                <h1 id="results-title" class="text-2xl md:text-3xl font-bold text-gray-800"></h1>
                <button class="flex-shrink-0 text-sm text-blue-600 font-medium hover:underline flex items-center gap-1">
                    Benzer r羹nleri Kar覺lat覺r
                </button>
            </div>
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- Fiyat kartlar覺 buraya JS ile eklenecek -->
            </div>
        </section>

        <!-- Kategori b繹l羹mleri bu sayfadan kald覺r覺ld覺 -->

    </main>

    <!-- 3. AI ALIVER襤 AS襤STANI -->
    <section id="ai-assistant-section" class="py-12 md:py-16 mt-12 rounded-t-xl shadow-inner-top">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-red-600">
                         K覺yasGO AI Asistan覺
                    </span>
                </h2>
                <p class="mt-3 text-lg text-gray-600">Kiisel e-ticaret dan覺man覺n覺z. Fiyattan fazlas覺n覺 sorun.</p>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                <!-- Chat Penceresi -->
                <div id="chat-window" class="h-80 overflow-y-auto p-6 space-y-4">
                    <!-- Balang覺癟 Mesaj覺 -->
                    <div class="flex justify-start">
                        <div class="bg-blue-100 text-blue-800 p-4 rounded-xl rounded-bl-none max-w-md">
                            <p class="font-medium">Merhaba! Ben K覺yasGO Asistan.</p>
                            <p class="mt-1">Bir 羹r羹n arad覺ktan sonra bana onun hakk覺nda sorular sorabilirsiniz. rnein: "Bu 羹r羹n羹 almaya deer mi?" veya "D羹mesini beklemeli miyim?"</p>
                        </div>
                    </div>
                    <!-- Mesajlar buraya eklenecek -->
                </div>
                
                <!-- rnek Sorular -->
                <div class="p-4 bg-gray-50 border-t border-b border-gray-200">
                    <p class="text-sm font-medium text-gray-600 mb-2 ml-2">H覺zl覺 sorular:</p>
                    <div id="suggestion-buttons" class="flex flex-wrap gap-2">
                        <button class="suggestion-btn">Bu 羹r羹n羹 almaya deer mi?</button>
                        <button class="suggestion-btn">Hangisi b羹t癟eme daha uygun?</button>
                        <button class="suggestion-btn">Fiyat d羹羹羹 i癟in beklemeli miyim?</button>
                        <button class="suggestion-btn">Kullan覺c覺 yorumlar覺 nas覺l?</button>
                    </div>
                </div>
                
                <!-- Chat Girdisi -->
                <div class="p-4 flex items-center gap-3 bg-white">
                    <input type="text" id="chat-input" placeholder="Asistana bir soru sorun..." class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" disabled>
                    <button id="chat-send-button" class="flex-shrink-0 bg-red-600 text-white rounded-full p-3 transition-all hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50" disabled>
                        <svg class="w-6 h-6 transform rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L6 12z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. FOOTER -->
    <footer class="bg-gray-800 text-gray-400 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="text-center md:text-left">
                    <a href="index.html" class="text-2xl font-extrabold text-blue-400">
                        K覺yas<span class="text-red-500">GO</span>
                    </a>
                    <p class="mt-2 text-sm">Ak覺ll覺 al覺veriin yeni adresi.</p>
                </div>
                <div class="flex gap-x-6 gap-y-2 flex-wrap justify-center">
                    <a href="#" class="hover:text-white transition-colors">Hakk覺m覺zda</a>
                    <a href="#" class="hover:text-white transition-colors">襤letiim</a>
                    <a href="#" class="hover:text-white transition-colors">Gizlilik Politikas覺</a>
                    <a href="#" class="hover:text-white transition-colors">Kullan覺m artlar覺</a>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-sm">
                <p>&copy; 2025 K覺yasGO. T羹m haklar覺 sakl覺d覺r.</p>
            </div>
        </div>
    </footer>

    <!-- YEN襤: Sadan A癟覺lan Men羹 -->
    <div id="side-menu-overlay" class="fixed inset-0 bg-black/50 z-50 hidden opacity-0"></div>
    <div id="side-menu" class="fixed top-0 right-0 h-full w-72 bg-white z-[60] shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out">
        <!-- Men羹 Bal覺覺 -->
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-xl font-bold text-gray-800">Men羹</h3>
            <button id="menu-close-btn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <!-- GNCELLEND襤: Men羹 襤癟erii (Kategoriler Eklendi) -->
        <nav class="p-4">
            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Giri Yap / Kay覺t Ol</a>
            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Profilim</a>
            
            <hr class="my-3">

            <h4 class="px-4 pt-2 pb-1 text-sm font-semibold text-gray-500 uppercase tracking-wider">Kategoriler</h4>
            <a href="index.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Ana Sayfa</a>
            <a href="elektronik.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Elektronik</a>
            <a href="moda.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Moda</a>
            <a href="ev-yasam.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Ev & Yaam</a>
            
            <hr class="my-3">

            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Ayarlar</a>
            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Yard覺m Merkezi</a>
        </nav>
    </div>

    <script>
        // --- DOM ELEMENTLER襤 ---
        // GNCELLEND襤: Mobil arama i癟in se癟iciler eklendi
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const searchButtonMobile = document.getElementById('search-button-mobile');
        
        // Sayfa b繹l羹mleri
        const pageStartMessage = document.getElementById('page-start-message'); // GNCELLEND襤
        const pageResultsSection = document.getElementById('page-results-section'); // GNCELLEND襤
        const resultsTitle = document.getElementById('results-title');
        const resultsGrid = document.getElementById('results-grid');
        
        // AI Chat
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const suggestionButtons = document.querySelectorAll('.suggestion-btn');

        // YEN襤: Yan Men羹 Se癟icileri
        const menuOpenBtn = document.getElementById('menu-open-btn');
        const menuCloseBtn = document.getElementById('menu-close-btn');
        const sideMenu = document.getElementById('side-menu');
        const sideMenuOverlay = document.getElementById('side-menu-overlay');

        let currentProduct = "";
        
        // --- ARAMA 襤LEV襤 (Sadece Ana Sayfa i癟in) ---
        // GNCELLEND襤: Mobil arama i癟in fonksiyonlar
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearch();
        });
        searchButtonMobile.addEventListener('click', performSearchMobile);
        searchInputMobile.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearchMobile();
        });

        function performSearch() {
            const query = searchInput.value.trim();
            if (!query) return;
            triggerSearch(query);
        }

        function performSearchMobile() {
            const query = searchInputMobile.value.trim();
            if (!query) return;
            triggerSearch(query);
        }

        function triggerSearch(query) {
            currentProduct = query;
            
            // Aray羹z羹 g羹ncelle
            if (pageStartMessage) pageStartMessage.classList.add('hidden'); // Balang覺癟 mesaj覺n覺 gizle
            if (pageResultsSection) pageResultsSection.classList.remove('hidden'); // Sonu癟lar覺 g繹ster
            
            resultsTitle.textContent = `"${query}" i癟in sonu癟lar`;
            resultsGrid.innerHTML = '<p class="text-gray-500">Fiyatlar getiriliyor...</p>';

            // AI Asistan覺n覺 aktive et
            chatInput.disabled = false;
            chatSendButton.disabled = false;
            chatInput.placeholder = `"${query}" hakk覺nda bir soru sorun...`;
            // GNCELLEND襤: Mock AI mesaj覺 yerine Gemini'ye haz覺r olduunu belirten bir mesaj
            addAiMessage(`"${query}" i癟in en iyi fiyatlar覺 listeledim. Bu 羹r羹nle ilgili sorular覺n覺z覺 yan覺tlamaya haz覺r覺m.`);

            setTimeout(() => {
                const mockResults = getMockResults(query);
                renderResults(mockResults);
            }, 1000);
        }

        // --- YEN襤: Yan Men羹 Fonksiyonlar覺 ---
        function openMenu() {
            sideMenuOverlay.classList.remove('hidden');
            requestAnimationFrame(() => {
                sideMenuOverlay.classList.add('opacity-100');
                sideMenu.classList.remove('translate-x-full');
            });
        }

        function closeMenu() {
            sideMenuOverlay.classList.remove('opacity-100');
            sideMenu.classList.add('translate-x-full');
            // Ge癟i bittikten sonra overlay'i gizle
            setTimeout(() => {
                sideMenuOverlay.classList.add('hidden');
            }, 300); // transition-duration-300
        }

        if (menuOpenBtn) {
            menuOpenBtn.addEventListener('click', openMenu);
        }
        if (menuCloseBtn) {
            menuCloseBtn.addEventListener('click', closeMenu);
        }
        if (sideMenuOverlay) {
            sideMenuOverlay.addEventListener('click', closeMenu);
        }

        // --- Dier Fonksiyonlar (Ayn覺) ---

        function getMockResults(query) {
            const stores = [
                { name: 'Trendyol', color: 'text-orange-600', link: 'https://www.trendyol.com' },
                { name: 'Hepsiburada', color: 'text-blue-700', link: 'https://www.hepsiburada.com' },
                { name: 'Amazon TR', color: 'text-yellow-500', link: 'https://www.amazon.com.tr' },
                { name: 'n11', color: 'text-red-600', link: 'https://www.n11.com' },
                { name: 'PttAVM', color: 'text-blue-500', link: 'https://www.pttavm.com' }
            ];
            let results = [];
            const basePrice = 45000 + (query.length * 100); 
            const storeCount = Math.floor(Math.random() * 3) + 3;
            const shuffledStores = stores.sort(() => 0.5 - Math.random());
            for (let i = 0; i < storeCount; i++) {
                const store = shuffledStores[i];
                const price = basePrice + Math.floor(Math.random() * 3000) - 1500;
                results.push({
                    storeName: store.name,
                    storeColor: store.color,
                    storeLink: store.link,
                    price: price,
                    productName: `${query} 256GB - ${store.name}`
                });
            }
            results.sort((a, b) => a.price - b.price);
            return results;
        }

        function renderResults(results) {
            resultsGrid.innerHTML = '';
            if (results.length === 0) {
                resultsGrid.innerHTML = '<p class="text-gray-500">Bu arama i癟in sonu癟 bulunamad覺.</p>';
                return;
            }
            results.forEach((item, index) => {
                const isBestPrice = index === 0;
                const cardHtml = `
                    <div class="bg-white border ${isBestPrice ? 'border-blue-500 shadow-lg' : 'border-gray-200 shadow-sm'} rounded-xl overflow-hidden transition-all hover:shadow-md relative">
                        ${isBestPrice ? '<div class="absolute top-0 right-0 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">En 襤yi Fiyat</div>' : ''}
                        <div class="p-5">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-xl font-bold ${item.storeColor}">${item.storeName}</span>
                            </div>
                            <p class="text-gray-700 h-12 mb-4">${item.productName}</p>
                            <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                                <span class="text-3xl font-extrabold text-gray-900">
                                    ${item.price.toLocaleString('tr-TR')} TL
                                </span>
                                <a href="${item.storeLink}" target="_blank" class="w-full sm:w-auto flex-shrink-0 text-center bg-blue-600 text-white font-medium px-6 py-3 rounded-full transition-all hover:bg-blue-700 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    Maazaya Git
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                resultsGrid.innerHTML += cardHtml;
            });
        }

        suggestionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const question = button.textContent;
                if (!chatInput.disabled) {
                    chatInput.value = question;
                    sendChatMessage();
                }
            });
            button.className = "bg-gray-100 text-gray-700 text-sm px-4 py-2 rounded-full transition-all hover:bg-gray-200 cursor-pointer";
        });

        // GNCELLEND襤: Gemini entegrasyonu i癟in async
        chatSendButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // GNCELLEND襤: sendChatMessage art覺k async
        async function sendChatMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;
            addUserMessage(messageText);
            chatInput.value = '';

            // Loading g繹stergesi ekle
            addAiMessage("Yapay zeka d羹羹n羹yor...", true);
            // GNCELLEND襤: Mock yan覺t yerine Gemini'yi 癟a覺r
            await getAiResponse(messageText);
        }

        function addUserMessage(message) {
            const messageHtml = `
                <div class="flex justify-end">
                    <div class="bg-gray-200 text-gray-800 p-4 rounded-xl rounded-br-none max-w-md">
                        <p>${message}</p>
                    </div>
                </div>
            `;
            chatWindow.innerHTML += messageHtml;
            scrollToBottom();
        }

        function addAiMessage(message) {
            const messageHtml = `
                <div class="flex justify-start">
                    <div class="bg-blue-100 text-blue-800 p-4 rounded-xl rounded-bl-none max-w-md">
                        <p>${message}</p>
                    </div>
                </div>
            `;
            chatWindow.innerHTML += messageHtml;
            scrollToBottom();
        }

        // GNCELLEND襤: addAiMessage 'isTyping' parametresi ald覺
        function addAiMessage(message, isTyping = false) {
            // nceki "d羹羹n羹yor" mesaj覺n覺 kald覺r
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            const messageHtml = `
                <div class="flex justify-start" ${isTyping ? 'id="typing-indicator"' : ''}>
                    <div class="bg-blue-100 text-blue-800 p-4 rounded-xl rounded-bl-none max-w-md">
                        <p>${isTyping ? '<i>' + message + '</i>' : message}</p>
                    </div>
                </div>
            `;
            chatWindow.innerHTML += messageHtml;
            scrollToBottom();
        }

        // YEN襤: Gemini API ar覺 Fonksiyonu
        /**
         * Gemini API'ye g羹venli ve yeniden deneyerek istek atar.
         * @param {string} userPrompt Kullan覺c覺n覺n tam sorgusu.
         * @returns {Promise<string>} API'den gelen metin yan覺t覺.
         */
        async function callGeminiApi(userPrompt) {
            const apiKey = ""; // Canvas ortam覺 taraf覺ndan salan覺r
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // S襤STEM PROMPTU: Yapay zekan覺n rol羹n羹 ve k覺s覺tlamalar覺n覺 belirler
            const systemPrompt = `
                Sen 'K覺yasGO AI Asistan覺' ad覺nda bir e-ticaret ve 羹r羹n kar覺lat覺rma uzman覺s覺n.
                G繹revin:
                1.  Sadece ve sadece 羹r羹nler, 羹r羹n 繹zellikleri (kamera, pil, ilemci vb.), fiyatlar, e-ticaret, al覺veri tavsiyeleri ve fiyat kar覺lat覺rmalar覺 hakk覺ndaki sorular覺 yan覺tla.
                2.  Kullan覺c覺 bir 羹r羹n aratt覺 (繹rn: "${currentProduct || 'bir 羹r羹n'}"). Sorular覺n覺 bu 羹r羹n balam覺nda deerlendir.
                3.  Yan覺tlar覺n k覺sa, net ve bilgilendirici olsun.
                4.  Konu d覺覺 (g羹nl羹k yaam, tarih, politika, sohbet vb.) sorular覺 KES襤NL襤KLE yan覺tlama. 
                5.  Konu d覺覺 bir soru gelirse, "zg羹n羹m, ben sadece 羹r羹nler ve al覺verile ilgili sorular覺n覺za yard覺mc覺 olabilirim." gibi nazik bir yan覺tla konuyu reddet.
            `;

            const payload = {
                contents: [{
                    parts: [{ text: userPrompt }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Google Search grounding'i etkinletir (daha g羹ncel yan覺tlar i癟in)
                tools: [{ "google_search": {} }],
            };

            let retries = 3;
            let delay = 1000; // 1 saniye

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // 429 (Too Many Requests) gibi durumlar i癟in yeniden deneme
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Sunucu hatas覺 veya h覺z s覺n覺r覺: ${response.status}`);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        // API'den ge癟erli bir yan覺t gelmezse (繹rn: g羹venlik filtreleri)
                        return "Sorunuzu u anda yan覺tlayam覺yorum. L羹tfen farkl覺 bir ekilde sormay覺 deneyin.";
                    }

                } catch (error) {
                    // console.error("Gemini API Hatas覺:", error.message); // Hata ay覺klama i癟in
                    retries--;
                    if (retries === 0) {
                        return "zg羹n羹m, u anda AI asistan覺na balan覺rken bir sorun ya覺yorum. L羹tfen daha sonra tekrar deneyin.";
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
            return "Asistana balan覺rken bir sorun olutu."; // Ekstra g羹venlik
        }


        // GNCELLEND襤: getAiResponse art覺k Gemini'yi 癟a覺r覺yor
        async function getAiResponse(question) {
            // Kullan覺c覺n覺n sorusunu ve mevcut 羹r羹n balam覺n覺 birletir
            const fullPrompt = `Kullan覺c覺 "${currentProduct || 'herhangi bir 羹r羹n'}" hakk覺nda bilgi ar覺yor ve unu sordu: "${question}"`;
            
            try {
                const response = await callGeminiApi(fullPrompt);
                addAiMessage(response); // "d羹羹n羹yor" mesaj覺n覺 API yan覺t覺yla deitirir
            } catch (error) {
                addAiMessage("Bir hata olutu. L羹tfen tekrar deneyin.");
            }
        }

        // KALDIRILDI: getLowestPrice fonksiyonu art覺k kullan覺lm覺yor.
        
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

    </script>
</body>
</html>

