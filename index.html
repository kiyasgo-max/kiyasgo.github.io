<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KıyasGO - Akıllı Fiyat Karşılaştırma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        #ai-assistant-section {
            background: linear-gradient(135deg, #eff6ff 0%, #ffebeb 100%);
        }
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 20px; }
        
        /* Aktif menü linki için stil */
        .nav-link.active {
            color: #2563eb; /* text-blue-600 */
            border-bottom-color: #2563eb; /* border-blue-600 */
        }
        /* YENİ: Menü geçiş stili */
        #side-menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">

    <!-- 1. HEADER: ARAMA ÇUBUĞU VE MENÜ -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <!-- GÜNCELLENDİ: Üst satır (Logo, Arama, Menü Butonu) -->
            <div class="flex justify-between items-center gap-4">
                <a href="index.html" class="text-3xl font-extrabold text-blue-600 flex-shrink-0">
                    Kıyas<span class="text-red-600">GO</span>
                </a>
                
                <div class="relative w-full max-w-2xl hidden md:block">
                    <input type="search" id="search-input" placeholder="Aradığınız ürünü yazın (örn: 'iPhone 15 Pro')" class="w-full pl-5 pr-12 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    <button id="search-button" class="absolute right-0 top-0 h-full px-5 text-gray-500 hover:text-blue-600 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                    </button>
                </div>

                <!-- YENİ: Hamburger Menü Butonu -->
                <button id="menu-open-btn" class="text-gray-600 hover:text-blue-600 p-2 rounded-full">
                    <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>

            <!-- GÜNCELLENDİ: Mobil için Arama Çubuğu (Üst satırın altında) -->
            <div class="relative w-full mt-4 md:hidden">
                <input type="search" id="search-input-mobile" placeholder="Aradığınız ürünü yazın..." class="w-full pl-5 pr-12 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <button id="search-button-mobile" class="absolute right-0 top-0 h-full px-5 text-gray-500 hover:text-blue-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </button>
            </div>


            <!-- KATEGORİ MENÜSÜ LİNKLERİ (BU BÖLÜM SİLİNDİ) -->

        </nav>
    </header>

    <!-- 2. ANA İÇERİK: ANA SAYFA -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[calc(100vh-450px)]">
        
        <!-- Başlangıç Mesajı -->
        <div id="page-start-message" class="page-section text-center text-gray-500 py-16">
            <svg class="w-16 h-16 mx-auto text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
            </svg>
            <h2 class="text-2xl font-semibold mt-4">En iyi fiyatları bulmaya başlayın</h2>
            <p class="text-lg mt-2">Karşılaştırmak istediğiniz ürünü yukarıdaki çubuğa yazın.</p>
        </div>

        <!-- Arama Sonuçları Bölümü -->
        <section id="page-results-section" class="page-section hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
                <h1 id="results-title" class="text-2xl md:text-3xl font-bold text-gray-800"></h1>
                <button class="flex-shrink-0 text-sm text-blue-600 font-medium hover:underline flex items-center gap-1">
                    Benzer Ürünleri Karşılaştır
                </button>
            </div>
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- Fiyat kartları buraya JS ile eklenecek -->
            </div>
        </section>

        <!-- Kategori bölümleri bu sayfadan kaldırıldı -->

    </main>

    <!-- 3. AI ALIŞVERİŞ ASİSTANI -->
    <section id="ai-assistant-section" class="py-12 md:py-16 mt-12 rounded-t-xl shadow-inner-top">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-red-600">
                        🤖 KıyasGO AI Asistanı
                    </span>
                </h2>
                <p class="mt-3 text-lg text-gray-600">Kişisel e-ticaret danışmanınız. Fiyattan fazlasını sorun.</p>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                <!-- Chat Penceresi -->
                <div id="chat-window" class="h-80 overflow-y-auto p-6 space-y-4">
                    <!-- Başlangıç Mesajı -->
                    <div class="flex justify-start">
                        <div class="bg-blue-100 text-blue-800 p-4 rounded-xl rounded-bl-none max-w-md">
                            <p class="font-medium">Merhaba! Ben KıyasGO Asistan.</p>
                            <p class="mt-1">Bir ürün aradıktan sonra bana onun hakkında sorular sorabilirsiniz. Örneğin: "Bu ürünü almaya değer mi?" veya "Düşmesini beklemeli miyim?"</p>
                        </div>
                    </div>
                    <!-- Mesajlar buraya eklenecek -->
                </div>
                
                <!-- Örnek Sorular -->
                <div class="p-4 bg-gray-50 border-t border-b border-gray-200">
                    <p class="text-sm font-medium text-gray-600 mb-2 ml-2">Hızlı sorular:</p>
                    <div id="suggestion-buttons" class="flex flex-wrap gap-2">
                        <button class="suggestion-btn">Bu ürünü almaya değer mi?</button>
                        <button class="suggestion-btn">Hangisi bütçeme daha uygun?</button>
                        <button class="suggestion-btn">Fiyat düşüşü için beklemeli miyim?</button>
                        <button class="suggestion-btn">Kullanıcı yorumları nasıl?</button>
                    </div>
                </div>
                
                <!-- Chat Girdisi -->
                <div class="p-4 flex items-center gap-3 bg-white">
                    <input type="text" id="chat-input" placeholder="Asistana bir soru sorun..." class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" disabled>
                    <button id="chat-send-button" class="flex-shrink-0 bg-red-600 text-white rounded-full p-3 transition-all hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50" disabled>
                        <svg class="w-6 h-6 transform rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L6 12z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. FOOTER -->
    <footer class="bg-gray-800 text-gray-400 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="text-center md:text-left">
                    <a href="index.html" class="text-2xl font-extrabold text-blue-400">
                        Kıyas<span class="text-red-500">GO</span>
                    </a>
                    <p class="mt-2 text-sm">Akıllı alışverişin yeni adresi.</p>
                </div>
                <div class="flex gap-x-6 gap-y-2 flex-wrap justify-center">
                    <a href="#" class="hover:text-white transition-colors">Hakkımızda</a>
                    <a href="#" class="hover:text-white transition-colors">İletişim</a>
                    <a href="#" class="hover:text-white transition-colors">Gizlilik Politikası</a>
                    <a href="#" class="hover:text-white transition-colors">Kullanım Şartları</a>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-sm">
                <p>&copy; 2025 KıyasGO. Tüm hakları saklıdır.</p>
            </div>
        </div>
    </footer>

    <!-- YENİ: Sağdan Açılan Menü -->
    <div id="side-menu-overlay" class="fixed inset-0 bg-black/50 z-50 hidden opacity-0"></div>
    <div id="side-menu" class="fixed top-0 right-0 h-full w-72 bg-white z-[60] shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out">
        <!-- Menü Başlığı -->
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-xl font-bold text-gray-800">Menü</h3>
            <button id="menu-close-btn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <!-- GÜNCELLENDİ: Menü İçeriği (Kategoriler Eklendi) -->
        <nav class="p-4">
            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Giriş Yap / Kayıt Ol</a>
            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Profilim</a>
            
            <hr class="my-3">

            <h4 class="px-4 pt-2 pb-1 text-sm font-semibold text-gray-500 uppercase tracking-wider">Kategoriler</h4>
            <a href="index.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Ana Sayfa</a>
            <a href="elektronik.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Elektronik</a>
            <a href="moda.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Moda</a>
            <a href="ev-yasam.html" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Ev & Yaşam</a>
            
            <hr class="my-3">

            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Ayarlar</a>
            <a href="#" class="block px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Yardım Merkezi</a>
        </nav>
    </div>

    <script>
        // --- DOM ELEMENTLERİ ---
        // GÜNCELLENDİ: Mobil arama için seçiciler eklendi
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const searchButtonMobile = document.getElementById('search-button-mobile');
        
        // Sayfa bölümleri
        const pageStartMessage = document.getElementById('page-start-message'); // GÜNCELLENDİ
        const pageResultsSection = document.getElementById('page-results-section'); // GÜNCELLENDİ
        const resultsTitle = document.getElementById('results-title');
        const resultsGrid = document.getElementById('results-grid');
        
        // AI Chat
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const suggestionButtons = document.querySelectorAll('.suggestion-btn');

        // YENİ: Yan Menü Seçicileri
        const menuOpenBtn = document.getElementById('menu-open-btn');
        const menuCloseBtn = document.getElementById('menu-close-btn');
        const sideMenu = document.getElementById('side-menu');
        const sideMenuOverlay = document.getElementById('side-menu-overlay');

        let currentProduct = "";
        
        // --- ARAMA İŞLEVİ (Sadece Ana Sayfa için) ---
        // GÜNCELLENDİ: Mobil arama için fonksiyonlar
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearch();
        });
        searchButtonMobile.addEventListener('click', performSearchMobile);
        searchInputMobile.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearchMobile();
        });

        function performSearch() {
            const query = searchInput.value.trim();
            if (!query) return;
            triggerSearch(query);
        }

        function performSearchMobile() {
            const query = searchInputMobile.value.trim();
            if (!query) return;
            triggerSearch(query);
        }

        function triggerSearch(query) {
            currentProduct = query;
            
            // Arayüzü güncelle
            if (pageStartMessage) pageStartMessage.classList.add('hidden'); // Başlangıç mesajını gizle
            if (pageResultsSection) pageResultsSection.classList.remove('hidden'); // Sonuçları göster
            
            resultsTitle.textContent = `"${query}" için sonuçlar`;
            resultsGrid.innerHTML = '<p class="text-gray-500">Fiyatlar getiriliyor...</p>';

            // AI Asistanını aktive et
            chatInput.disabled = false;
            chatSendButton.disabled = false;
            chatInput.placeholder = `"${query}" hakkında bir soru sorun...`;
            // GÜNCELLENDİ: Mock AI mesajı yerine Gemini'ye hazır olduğunu belirten bir mesaj
            addAiMessage(`"${query}" için en iyi fiyatları listeledim. Bu ürünle ilgili sorularınızı yanıtlamaya hazırım.`);

            setTimeout(() => {
                const mockResults = getMockResults(query);
                renderResults(mockResults);
            }, 1000);
        }

        // --- YENİ: Yan Menü Fonksiyonları ---
        function openMenu() {
            sideMenuOverlay.classList.remove('hidden');
            requestAnimationFrame(() => {
                sideMenuOverlay.classList.add('opacity-100');
                sideMenu.classList.remove('translate-x-full');
            });
        }

        function closeMenu() {
            sideMenuOverlay.classList.remove('opacity-100');
            sideMenu.classList.add('translate-x-full');
            // Geçiş bittikten sonra overlay'i gizle
            setTimeout(() => {
                sideMenuOverlay.classList.add('hidden');
            }, 300); // transition-duration-300
        }

        if (menuOpenBtn) {
            menuOpenBtn.addEventListener('click', openMenu);
        }
        if (menuCloseBtn) {
            menuCloseBtn.addEventListener('click', closeMenu);
        }
        if (sideMenuOverlay) {
            sideMenuOverlay.addEventListener('click', closeMenu);
        }

        // --- Diğer Fonksiyonlar (Aynı) ---

        function getMockResults(query) {
            const stores = [
                { name: 'Trendyol', color: 'text-orange-600', link: 'https://www.trendyol.com' },
                { name: 'Hepsiburada', color: 'text-blue-700', link: 'https://www.hepsiburada.com' },
                { name: 'Amazon TR', color: 'text-yellow-500', link: 'https://www.amazon.com.tr' },
                { name: 'n11', color: 'text-red-600', link: 'https://www.n11.com' },
                { name: 'PttAVM', color: 'text-blue-500', link: 'https://www.pttavm.com' }
            ];
            let results = [];
            const basePrice = 45000 + (query.length * 100); 
            const storeCount = Math.floor(Math.random() * 3) + 3;
            const shuffledStores = stores.sort(() => 0.5 - Math.random());
            for (let i = 0; i < storeCount; i++) {
                const store = shuffledStores[i];
                const price = basePrice + Math.floor(Math.random() * 3000) - 1500;
                results.push({
                    storeName: store.name,
                    storeColor: store.color,
                    storeLink: store.link,
                    price: price,
                    productName: `${query} 256GB - ${store.name}`
                });
            }
            results.sort((a, b) => a.price - b.price);
            return results;
        }

        function renderResults(results) {
            resultsGrid.innerHTML = '';
            if (results.length === 0) {
                resultsGrid.innerHTML = '<p class="text-gray-500">Bu arama için sonuç bulunamadı.</p>';
                return;
            }
            results.forEach((item, index) => {
                const isBestPrice = index === 0;
                const cardHtml = `
                    <div class="bg-white border ${isBestPrice ? 'border-blue-500 shadow-lg' : 'border-gray-200 shadow-sm'} rounded-xl overflow-hidden transition-all hover:shadow-md relative">
                        ${isBestPrice ? '<div class="absolute top-0 right-0 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">En İyi Fiyat</div>' : ''}
                        <div class="p-5">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-xl font-bold ${item.storeColor}">${item.storeName}</span>
                            </div>
                            <p class="text-gray-700 h-12 mb-4">${item.productName}</p>
                            <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                                <span class="text-3xl font-extrabold text-gray-900">
                                    ${item.price.toLocaleString('tr-TR')} TL
                                </span>
                                <a href="${item.storeLink}" target="_blank" class="w-full sm:w-auto flex-shrink-0 text-center bg-blue-600 text-white font-medium px-6 py-3 rounded-full transition-all hover:bg-blue-700 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    Mağazaya Git
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                resultsGrid.innerHTML += cardHtml;
            });
        }

        suggestionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const question = button.textContent;
                if (!chatInput.disabled) {
                    chatInput.value = question;
                    sendChatMessage();
                }
            });
            button.className = "bg-gray-100 text-gray-700 text-sm px-4 py-2 rounded-full transition-all hover:bg-gray-200 cursor-pointer";
        });

        // GÜNCELLENDİ: Gemini entegrasyonu için async
        chatSendButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // GÜNCELLENDİ: sendChatMessage artık async
        async function sendChatMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;
            addUserMessage(messageText);
            chatInput.value = '';

            // Loading göstergesi ekle
            addAiMessage("Yapay zeka düşünüyor...", true);
            // GÜNCELLENDİ: Mock yanıt yerine Gemini'yi çağır
            await getAiResponse(messageText);
        }

        function addUserMessage(message) {
            const messageHtml = `
                <div class="flex justify-end">
                    <div class="bg-gray-200 text-gray-800 p-4 rounded-xl rounded-br-none max-w-md">
                        <p>${message}</p>
                    </div>
                </div>
            `;
            chatWindow.innerHTML += messageHtml;
            scrollToBottom();
        }

        function addAiMessage(message) {
            const messageHtml = `
                <div class="flex justify-start">
                    <div class="bg-blue-100 text-blue-800 p-4 rounded-xl rounded-bl-none max-w-md">
                        <p>${message}</p>
                    </div>
                </div>
            `;
            chatWindow.innerHTML += messageHtml;
            scrollToBottom();
        }

        // GÜNCELLENDİ: addAiMessage 'isTyping' parametresi aldı
        function addAiMessage(message, isTyping = false) {
            // Önceki "düşünüyor" mesajını kaldır
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            const messageHtml = `
                <div class="flex justify-start" ${isTyping ? 'id="typing-indicator"' : ''}>
                    <div class="bg-blue-100 text-blue-800 p-4 rounded-xl rounded-bl-none max-w-md">
                        <p>${isTyping ? '<i>' + message + '</i>' : message}</p>
                    </div>
                </div>
            `;
            chatWindow.innerHTML += messageHtml;
            scrollToBottom();
        }

        // YENİ: Gemini API Çağrı Fonksiyonu
        /**
         * Gemini API'ye güvenli ve yeniden deneyerek istek atar.
         * @param {string} userPrompt Kullanıcının tam sorgusu.
         * @returns {Promise<string>} API'den gelen metin yanıtı.
         */
        async function callGeminiApi(userPrompt) {
            const apiKey = ""; // Canvas ortamı tarafından sağlanır
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // SİSTEM PROMPTU: Yapay zekanın rolünü ve kısıtlamalarını belirler
            const systemPrompt = `
                Sen 'KıyasGO AI Asistanı' adında bir e-ticaret ve ürün karşılaştırma uzmanısın.
                Görevin:
                1.  Sadece ve sadece ürünler, ürün özellikleri (kamera, pil, işlemci vb.), fiyatlar, e-ticaret, alışveriş tavsiyeleri ve fiyat karşılaştırmaları hakkındaki soruları yanıtla.
                2.  Kullanıcı bir ürün arattı (örn: "${currentProduct || 'bir ürün'}"). Sorularını bu ürün bağlamında değerlendir.
                3.  Yanıtların kısa, net ve bilgilendirici olsun.
                4.  Konu dışı (günlük yaşam, tarih, politika, sohbet vb.) soruları KESİNLİKLE yanıtlama. 
                5.  Konu dışı bir soru gelirse, "Üzgünüm, ben sadece ürünler ve alışverişle ilgili sorularınıza yardımcı olabilirim." gibi nazik bir yanıtla konuyu reddet.
            `;

            const payload = {
                contents: [{
                    parts: [{ text: userPrompt }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Google Search grounding'i etkinleştir (daha güncel yanıtlar için)
                tools: [{ "google_search": {} }],
            };

            let retries = 3;
            let delay = 1000; // 1 saniye

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // 429 (Too Many Requests) gibi durumlar için yeniden deneme
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Sunucu hatası veya hız sınırı: ${response.status}`);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        // API'den geçerli bir yanıt gelmezse (örn: güvenlik filtreleri)
                        return "Sorunuzu şu anda yanıtlayamıyorum. Lütfen farklı bir şekilde sormayı deneyin.";
                    }

                } catch (error) {
                    // console.error("Gemini API Hatası:", error.message); // Hata ayıklama için
                    retries--;
                    if (retries === 0) {
                        return "Üzgünüm, şu anda AI asistanına bağlanırken bir sorun yaşıyorum. Lütfen daha sonra tekrar deneyin.";
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
            return "Asistana bağlanırken bir sorun oluştu."; // Ekstra güvenlik
        }


        // GÜNCELLENDİ: getAiResponse artık Gemini'yi çağırıyor
        async function getAiResponse(question) {
            // Kullanıcının sorusunu ve mevcut ürün bağlamını birleştir
            const fullPrompt = `Kullanıcı "${currentProduct || 'herhangi bir ürün'}" hakkında bilgi arıyor ve şunu sordu: "${question}"`;
            
            try {
                const response = await callGeminiApi(fullPrompt);
                addAiMessage(response); // "düşünüyor" mesajını API yanıtıyla değiştirir
            } catch (error) {
                addAiMessage("Bir hata oluştu. Lütfen tekrar deneyin.");
            }
        }

        // KALDIRILDI: getLowestPrice fonksiyonu artık kullanılmıyor.
        
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

    </script>
</body>
</html>

